@model List<PuanOdulSistemi.Models.Kullanici>
@{
    ViewData["Title"] = "Ogrenciler";
    ViewData["Active"] = "Ogrenciler";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var oduller = ViewBag.Oduller as List<PuanOdulSistemi.Models.Odul> ?? new();
    var okullar = ViewBag.Okullar as List<PuanOdulSistemi.Models.OkulBilgisi> ?? new();
}

<div class="page-head">
    <p>Toplam <strong>@Model.Count</strong> ogrenci kayitli.</p>
    <a href="/Admin/OgrenciEkle" class="btn btn-primary btn-sm">
        <i class="bi bi-person-plus-fill me-1"></i> Ogrenci Ekle
    </a>
</div>

@if (!Model.Any())
{
    <section class="surface-card empty-state">
        <div class="empty-icon"><i class="bi bi-people"></i></div>
        <h4>Henuz ogrenci yok</h4>
        <p>Ilk ogrenciyi ekleyerek sistemi kullanmaya baslayabilirsin.</p>
        <a href="/Admin/OgrenciEkle" class="btn btn-primary">Ogrenci Ekle</a>
    </section>
}
else
{
    <div class="student-grid">
        @foreach (var ogr in Model)
        {
            var basvurular = ogr.PuanBasvurulari.ToList();
            var onaylananlar = basvurular.Where(b => b.Durum == "Onaylandi").ToList();
            int toplamPuan = onaylananlar.Sum(b => b.Puan);
            double ortalama = onaylananlar.Count > 0 ? onaylananlar.Average(b => b.Puan) : 0;
            var kazanilanOduller = oduller.Where(o => o.GerekliPuan <= toplamPuan).ToList();
            var enIyiOkul = okullar.Where(o => ortalama >= o.TabanPuan).FirstOrDefault();
            int bekleyenSayi = basvurular.Count(b => b.Durum == "Bekliyor");

            <article class="student-card">
                <header class="student-card-head">
                    <div class="student-head-row">
                        <span class="student-avatar">
                            @if (!string.IsNullOrWhiteSpace(ogr.ProfilFotografYolu))
                            {
                                <img src="@ogr.ProfilFotografYolu" alt="Profil fotografi" class="student-avatar-img" />
                            }
                            else
                            {
                                @(ogr.Ad?.Length > 0 ? ogr.Ad[0].ToString().ToUpper() : "?")
                            }
                        </span>
                        <div>
                            <p class="student-name">@ogr.Ad</p>
                            <p class="student-user">&#64;@ogr.KullaniciAdi</p>
                        </div>
                        <div class="student-score">
                            <strong>@ortalama.ToString("F1")</strong>
                            <span>ort</span>
                        </div>
                    </div>
                </header>

                <div class="student-stats">
                    <div class="student-stat">
                        <strong class="text-warning">@bekleyenSayi</strong>
                        <span>Bekleyen</span>
                    </div>
                    <div class="student-stat">
                        <strong class="text-success">@onaylananlar.Count</strong>
                        <span>Onayli</span>
                    </div>
                    <div class="student-stat">
                        <strong class="text-primary">@kazanilanOduller.Count</strong>
                        <span>Odul</span>
                    </div>
                </div>

                <div class="student-body">
                    @if (enIyiOkul != null)
                    {
                        <div class="mini-chip success mb-2">
                            <i class="bi bi-mortarboard-fill me-1"></i>@enIyiOkul.Ad
                        </div>
                    }
                    else if (ortalama > 0)
                    {
                        <div class="mini-chip mb-2">
                            <i class="bi bi-mortarboard me-1"></i>Ort: @ortalama.ToString("F1"), esik alti
                        </div>
                    }

                    @if (kazanilanOduller.Any())
                    {
                        @foreach (var odul in kazanilanOduller.Take(3))
                        {
                            <span class="mini-chip accent">
                                <i class="bi bi-gift-fill me-1"></i>@odul.Ad
                            </span>
                        }
                        @if (kazanilanOduller.Count > 3)
                        {
                            <span class="mini-chip">+@(kazanilanOduller.Count - 3)</span>
                        }
                    }
                    else
                    {
                        <p class="student-empty-text">Henuz odul kazanilmadi.</p>
                    }
                </div>
            </article>
        }
    </div>
}
