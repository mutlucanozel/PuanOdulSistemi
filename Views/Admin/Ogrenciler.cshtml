@model List<PuanOdulSistemi.Models.Kullanici>
@{
    ViewData["Title"] = "√ñƒürenciler";
    ViewData["Active"] = "Ogrenciler";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var oduller = ViewBag.Oduller as List<PuanOdulSistemi.Models.Odul> ?? new();
    var okullar = ViewBag.Okullar as List<PuanOdulSistemi.Models.OkulBilgisi> ?? new();
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="text-muted">Toplam @Model.Count √∂ƒürenci</span>
    <a href="/Admin/OgrenciEkle" class="btn btn-primary btn-sm">
        <i class="bi bi-person-plus me-1"></i>√ñƒürenci Ekle
    </a>
</div>

@if (!Model.Any())
{
    <div class="card p-5 text-center text-muted">
        <div style="font-size: 3rem;">üë•</div>
        <p class="mt-2">Hen√ºz √∂ƒürenci yok.</p>
        <a href="/Admin/OgrenciEkle" class="btn btn-primary">√ñƒürenci Ekle</a>
    </div>
}
else
{
    <div class="row g-3">
        @foreach (var ogr in Model)
        {
            var basvurular = ogr.PuanBasvurulari.ToList();
            var onaylananlar = basvurular.Where(b => b.Durum == "Onaylandi").ToList();
            int toplamPuan = onaylananlar.Sum(b => b.Puan);
            double ortalama = onaylananlar.Count > 0 ? onaylananlar.Average(b => b.Puan) : 0;
            var kazanilanOduller = oduller.Where(o => o.GerekliPuan <= toplamPuan).ToList();
            var enIyiOkul = okullar.Where(o => ortalama >= o.TabanPuan).FirstOrDefault();

            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="fw-bold mb-0">@ogr.Ad</h6>
                            <span class="text-muted small">@@@ogr.KullaniciAdi</span>
                        </div>
                        <span class="fs-4 fw-bold text-primary">@toplamPuan <small class="text-muted fs-6">puan</small></span>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4 text-center bg-light rounded p-2">
                            <div class="fw-bold text-warning">@basvurular.Count(b => b.Durum == "Bekliyor")</div>
                            <small class="text-muted">Bekleyen</small>
                        </div>
                        <div class="col-4 text-center bg-light rounded p-2">
                            <div class="fw-bold text-success">@onaylananlar.Count</div>
                            <small class="text-muted">Onaylanan</small>
                        </div>
                        <div class="col-4 text-center bg-light rounded p-2">
                            <div class="fw-bold" style="color: #8b5cf6;">@kazanilanOduller.Count</div>
                            <small class="text-muted">√ñd√ºl</small>
                        </div>
                    </div>

                    @if (enIyiOkul != null)
                    {
                        <div class="alert alert-success py-2 small mb-2">
                            <i class="bi bi-mortarboard me-1"></i>
                            <strong>@enIyiOkul.Ad</strong>
                            <span class="text-muted ms-1">(ort: @ortalama.ToString("F1"))</span>
                        </div>
                    }
                    else if (ortalama > 0)
                    {
                        <div class="alert alert-secondary py-2 small mb-2">
                            <i class="bi bi-mortarboard me-1"></i>Ortalama: @ortalama.ToString("F1") ‚Äî okul e≈üiƒüi yok
                        </div>
                    }

                    @if (kazanilanOduller.Any())
                    {
                        <div class="d-flex flex-wrap gap-1">
                            @foreach (var odul in kazanilanOduller)
                            {
                                <span class="badge rounded-pill" style="background-color: #ede9fe; color: #7c3aed;">üéÅ @odul.Ad</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}
