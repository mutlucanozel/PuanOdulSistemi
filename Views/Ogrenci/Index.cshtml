@model List<PuanOdulSistemi.Models.PuanBasvurusu>
@{
    ViewData["Title"] = "Ana Sayfa";
    ViewData["Active"] = "Index";
    Layout = "~/Views/Shared/_OgrenciLayout.cshtml";

    int toplamPuan = ViewBag.ToplamPuan ?? 0;
    int bekleyenSayi = ViewBag.BekleyenSayi ?? 0;
    int onaylananSayi = ViewBag.OnaylananSayi ?? 0;
    var kazanilanOduller = ViewBag.KazanilanOduller as List<PuanOdulSistemi.Models.Odul> ?? new();
    var tumOduller = ViewBag.TumOduller as List<PuanOdulSistemi.Models.Odul> ?? new();
    var okullar = ViewBag.Okullar as List<PuanOdulSistemi.Models.OkulBilgisi> ?? new();
    double ortalama = onaylananSayi > 0 ? (double)toplamPuan / onaylananSayi : 0;
    var enIyiOkul = okullar.Where(o => ortalama >= o.TabanPuan).FirstOrDefault();
}

@if (TempData["Basari"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-3">
        <i class="bi bi-check-circle-fill me-1"></i> @TempData["Basari"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="metric-grid mb-3">
    <div class="metric-card primary">
        <div class="metric-head">
            <span class="metric-icon"><i class="bi bi-star-fill"></i></span>
            <span class="status-badge">Ortalama</span>
        </div>
        <div class="metric-value">@ortalama.ToString("F1")</div>
        <div class="metric-label">Onayli puan ortalaman</div>
    </div>

    <div class="metric-card warning">
        <div class="metric-head">
            <span class="metric-icon"><i class="bi bi-hourglass-split"></i></span>
            <span class="status-badge">Surec</span>
        </div>
        <div class="metric-value">@bekleyenSayi</div>
        <div class="metric-label">Bekleyen basvuru</div>
    </div>

    <div class="metric-card success">
        <div class="metric-head">
            <span class="metric-icon"><i class="bi bi-check2-circle"></i></span>
            <span class="status-badge">Onay</span>
        </div>
        <div class="metric-value">@onaylananSayi</div>
        <div class="metric-label">Onaylanan aktivite</div>
    </div>

    <div class="metric-card secondary">
        <div class="metric-head">
            <span class="metric-icon"><i class="bi bi-gift-fill"></i></span>
            <span class="status-badge">Odul</span>
        </div>
        <div class="metric-value">@kazanilanOduller.Count</div>
        <div class="metric-label">Kazanilan odul</div>
    </div>
</div>

<div class="section-grid mb-3">
    <section class="surface-card p-3">
        <h2 class="surface-title mb-1"><i class="bi bi-mortarboard-fill me-2"></i>Okul Tahmini</h2>
        <p class="surface-subtitle mb-3">Onayli puan ortalamanla olasi okul durumun.</p>

        @if (ortalama > 0)
        {
            <p class="mb-2">Ortalaman: <strong class="text-primary fs-5">@ortalama.ToString("F2")</strong></p>
            @if (enIyiOkul != null)
            {
                <div class="alert alert-success py-2 mb-2">
                    <i class="bi bi-check-circle-fill me-1"></i> <strong>@enIyiOkul.Ad</strong>ðŸŽ‰ðŸŽ‰ðŸŽ‰ icin puanin yeterli.
                </div>
            }
            else
            {
                <div class="alert alert-warning py-2 mb-2">
                    <i class="bi bi-exclamation-circle-fill me-1"></i> Henuz bir okul esigine ulasilmadi.
                </div>
            }
        }
        else
        {
            <p class="surface-subtitle mb-2">Henuz onayli puan olusmadi.</p>
        }

        <a href="/Ogrenci/OkulTahmini" class="btn btn-outline-primary btn-sm">Tum okullari gor</a>
    </section>

    <section class="surface-card p-3">
        <h2 class="surface-title mb-1"><i class="bi bi-trophy-fill me-2"></i>Tum Oduller</h2>
        <p class="surface-subtitle mb-3">Tum oduller gorselleriyle burada listelenir.</p>

        @if (tumOduller.Any())
        {
            <div class="reward-grid">
                @foreach (var odul in tumOduller)
                {
                    bool kazanildi = toplamPuan >= odul.GerekliPuan;
                    int ilerleme = odul.GerekliPuan > 0 ? (int)Math.Min(100, (double)toplamPuan / odul.GerekliPuan * 100) : 100;

                    <article class="reward-card">
                        <div class="reward-media position-relative">
                            @if (!string.IsNullOrEmpty(odul.GorselYolu))
                            {
                                <img src="@odul.GorselYolu" alt="@odul.Ad" />
                            }
                            else
                            {
                                <i class="bi bi-gift-fill"></i>
                            }

                            <span class="position-absolute top-0 end-0 m-2 reward-state @(kazanildi ? "done" : "pending")">
                                <i class="bi @(kazanildi ? "bi-check-circle-fill" : "bi-hourglass-split")"></i>
                                @(kazanildi ? "Kazanildi" : "Bekliyor")
                            </span>
                        </div>

                        <div class="reward-body">
                            <h6>@odul.Ad</h6>
                            @if (!string.IsNullOrEmpty(odul.Aciklama))
                            {
                                <p>@odul.Aciklama</p>
                            }

                            <div class="d-flex justify-content-between mb-1 small">
                                <span class="text-muted">Gerekli puan</span>
                                <strong class="text-primary">@odul.GerekliPuan</strong>
                            </div>
                            <div class="progress-soft mb-1">
                                <div class="bar" style="width:@ilerleme%"></div>
                            </div>
                            <small class="text-muted">
                                @(kazanildi ? "Tamamlandi" : $"{toplamPuan} / {odul.GerekliPuan}")
                            </small>
                        </div>
                    </article>
                }
            </div>
        }
        else
        {
            <p class="surface-subtitle">Henuz odul tanimlanmadi.</p>
        }
    </section>
</div>

<section class="surface-card p-3">
    <div class="page-head mb-2">
        <p>Son gonderdigin basvurular.</p>
        <a href="/Ogrenci/Puanlarim" class="btn btn-outline-primary btn-sm">Tumunu Gor</a>
    </div>

    @if (!Model.Any())
    {
        <div class="empty-state py-4">
            <div class="empty-icon"><i class="bi bi-journal-plus"></i></div>
            <h5>Henuz basvuru yok</h5>
            <p>Ilk puan basvurunu eklemek icin hemen basla.</p>
            <a href="/Ogrenci/PuanGir" class="btn btn-primary">Puan Gir</a>
        </div>
    }
    else
    {
        <div class="table-shell">
            <div class="table-responsive">
                <table class="table table-modern align-middle">
                    <thead>
                        <tr>
                            <th>Aktivite</th>
                            <th>Puan</th>
                            <th>Durum</th>
                            <th>Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in Model)
                        {
                            <tr>
                                <td class="fw-semibold">@b.AktiviteAdi</td>
                                <td><strong class="text-primary">@b.Puan</strong></td>
                                <td>
                                    @if (b.Durum == "Onaylandi")
                                    {
                                        <span class="status-badge success"><i class="bi bi-check-lg"></i> Onaylandi</span>
                                    }
                                    else if (b.Durum == "Bekliyor")
                                    {
                                        <span class="status-badge warning"><i class="bi bi-hourglass-split"></i> Bekliyor</span>
                                    }
                                    else
                                    {
                                        <span class="status-badge danger"><i class="bi bi-x-lg"></i> Reddedildi</span>
                                    }
                                </td>
                                <td class="text-muted">@b.GondermeTarihi.ToString("dd MMM yyyy")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</section>
